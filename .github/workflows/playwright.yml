name: Playwright UI E2E

on:
  workflow_dispatch:
    inputs:
      runMobile:
        description: 'Run mobile tests after desktop tests?'
        required: true
        default: 'true' # If you don't want to run mobile tests after desktop, set the value to false
  schedule:
    # Run each day at 21:10
    - cron: "10 21 * * *"
  pull_request:
    paths:
      - "ui_tests_playwright/**"

# To cancel previous run within one PR after pushing new commit (if previous still in progress)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests_e2e:
    uses: ./.github/workflows/common-test-steps.yml
    with:
      project: Desktop_Chrome
      grep: "@desktop"
      slackTitle: TypeScript UI tests
    secrets:
      awsKey: ${{ secrets.AWS_KEY }}
      awsPassword: ${{ secrets.AWS_PASSWORD }}
      jiraAuthToken: ${{ secrets.JIRA_AUTH_TOKEN }}
      slackWebHook: ${{ secrets.SLACK_WEBHOOK }}
    
  run_mobile_tests:
    needs: tests_e2e
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.run_mobile == 'true' || github.event_name == 'schedule' || github.event_name == 'pull_request' }} 
    steps:
      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            let eventName = '';
            if ('${{ github.event_name }}' === 'schedule') {
              eventName = 'schedule';
            }
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'playwright-mobile.yml',
              ref: '${{ github.event.pull_request.head.ref }}',
              inputs: {
                eventName: eventName
              }
            });
